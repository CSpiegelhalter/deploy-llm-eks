# name: Build, Push, and Deploy
# on:
#   push:
#     branches: [ main ]
#     paths:
#       - 'app/**'
#       - 'k8s/apps/fastapi-gateway/**'
#       - '.github/workflows/ci-build-deploy.yml'

# jobs:
#   build-push-deploy:
#     runs-on: ubuntu-latest
#     env:
#       AWS_REGION: us-east-1
#       ECR_REPO: fastapi-model
#     steps:
#       - uses: actions/checkout@v4

#       - name: Configure AWS OIDC
#         uses: aws-actions/configure-aws-credentials@v4
#         with:
#           aws-region: ${{ env.AWS_REGION }}
#           role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/GithubOIDCRole

#       - name: Login to ECR
#         uses: aws-actions/amazon-ecr-login@v2

#       - name: Build and Push FastAPI
#         run: |
#           ECR_URI=${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO}
#           docker build -t ${ECR_URI}:${GITHUB_SHA} ./app
#           docker push ${ECR_URI}:${GITHUB_SHA}
#           echo "ECR_URI=${ECR_URI}" >> $GITHUB_ENV

#       - name: Bump Helm values with new image tag
#         run: |
#           FILE=k8s/apps/fastapi-gateway/values.yaml
#           sed -i "s|^  repository:.*|  repository: ${ECR_URI}|" $FILE
#           sed -i "s|^  tag:.*|  tag: \"${GITHUB_SHA}\"|" $FILE
#           git config user.name "github-actions[bot]"
#           git config user.email "github-actions[bot]@users.noreply.github.com"
#           git add $FILE
#           git commit -m "chore: deploy ${GITHUB_SHA}" || echo "No changes to commit"
#           git push || true
